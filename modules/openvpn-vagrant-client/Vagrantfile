# - bring up the vpn access server
# - start with: ./wake -init

# Ensure you have the vagrant guest plugin:
# vagrant plugin install vagrant-vbguest

require 'json'

# bridgenic = "en0: Wi-Fi (Wireless)" # eg: 'none' or 'en0: Wi-Fi (AirPort)'
bridgenic = "en7: Thunderbolt Ethernet"
# bridgenic = "none" # use none if you do not know the network connection, you will be prompted.

configure_aws = ENV['configure_aws'] || 'false'
if configure_aws == 'true'
    aws_region = ENV['aws_region']
    aws_access_key = ENV['aws_access_key']
    aws_secret_key = ENV['aws_secret_key']
end

if File.file?('ip_addresses.json')
    ip_addresses = JSON.parse(File.read(File.join(File.dirname(__FILE__), 'ip_addresses.json')))
    resourcetier = ip_addresses["resourcetier"]
    onsite_private_vpn_mac = ip_addresses["#{resourcetier}"]["onsite_private_vpn_mac"] # Generated by scripts/random_mac_unicast.sh
    onsite_private_vpn_ip = ip_addresses["#{resourcetier}"]["onsite_private_vpn_ip"]
else
    resourcetier = ENV['resourcetier']
    onsite_private_vpn_mac = 'none'
    onsite_private_vpn_ip = 'none'
end
network = 'public'
selected_ansible_version = 'latest'
syscontrol_gid = 9003
deployuser_uid = 9004

firehawkgateway_box = "bento/ubuntu-18.04"
box_version = "202105.25.0 "

timezone_localpath = "/usr/share/zoneinfo/Australia/Adelaide" # The Ubuntu file path to configure time / date for your current onsite timezone
openfirehawkserver_name = "firehawkgateway#{resourcetier}"

# If box file in is not defined, we will use the bento base image and provision as normal.  Box file in is not the full box name, but numeric, usually marking a stage for CI

servers=[
  {
    :hostname => openfirehawkserver_name,
    :mac_string => onsite_private_vpn_mac,
    :ip => onsite_private_vpn_ip,
    :bridgenic => bridgenic,
    :promisc => true,
    :box => firehawkgateway_box,
    :ram => 8192,
    :cpu => 4,
    :primary => false
  }
]

Vagrant.configure(2) do |config|
    config.vbguest.iso_path = "https://download.virtualbox.org/virtualbox/6.0.14/VBoxGuestAdditions_6.0.14.iso"
    config.vbguest.auto_update = false
    
    servers.each do |machine|
        config.vm.define machine[:hostname], primary: machine[:primary] do |node|
            node.vm.box = machine[:box]
            node.vm.hostname = machine[:hostname]

            node.vm.define machine[:hostname]
            node.vagrant.plugins = ['vagrant-vbguest', 'vagrant-reload']
            mac_string = machine[:mac_string]
            if network == 'public'
                # if you don't know the exact string for the bridgenic, eg '1) en0: Wi-Fi (AirPort)' then leave it as 'none'
                if bridgenic == 'none'
                    if mac_string == 'none'
                        node.vm.network "public_network", use_dhcp_assigned_default_route: true
                    else
                        node.vm.network "public_network", mac: mac_string, use_dhcp_assigned_default_route: true
                    end
                else
                    if mac_string == 'none'
                        node.vm.network "public_network", use_dhcp_assigned_default_route: true, bridge: bridgenic
                    else
                        node.vm.network "public_network", mac: mac_string, use_dhcp_assigned_default_route: true, bridge: bridgenic
                    end
                end
            else
                # use a private network mode if you don't have control over the network environment - eg wifi in a cafe / other location.
                if mac_string == 'none'
                    node.vm.network "private_network", use_dhcp_assigned_default_route: true
                else
                    node.vm.network "private_network", ip: machine[:ip], mac: mac_string, use_dhcp_assigned_default_route: true
                end
            end
            node.vm.provider "virtualbox" do |vb|
                vb.customize [ "guestproperty", "set", :id, "/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold", 1000 ]
                # Display the VirtualBox GUI when booting the machine
                vb.gui = false
                # Promisc mode is needed for open vpn gateway to forward packets
                if machine[:promisc] == true
                    vb.customize ["modifyvm", :id, "--nicpromisc2", "allow-all"]
                    vb.customize ["modifyvm", :id, "--nicpromisc3", "allow-all"]
                end
                # Customize the amount of memory on the VM:
                vb.customize ["modifyvm", :id, "--memory", machine[:ram]]
                vb.customize ["modifyvm", :id, "--cpus", machine[:cpu]]
            end
            node.vm.box_version = box_version
            node.vm.provision "shell", inline: "echo 'create syscontrol group'"
            node.vm.provision "shell", inline: "getent group syscontrol || sudo groupadd -g #{syscontrol_gid} syscontrol"
            node.vm.provision "shell", inline: "sudo usermod -aG syscontrol vagrant"
            node.vm.provision "shell", inline: "id -u deployuser &>/dev/null || sudo useradd -m -s /bin/bash -U deployuser -u #{deployuser_uid}"
            node.vm.provision "shell", inline: "sudo usermod -aG syscontrol deployuser"
            node.vm.provision "shell", inline: "sudo usermod -aG sudo deployuser"
            # give deploy user initial passwordless sudo as with vagrant user.
            node.vm.provision "shell", inline: "touch /etc/sudoers.d/98_deployuser; grep -qxF 'deployuser ALL=(ALL) NOPASSWD:ALL' /etc/sudoers.d/98_deployuser || echo 'deployuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers.d/98_deployuser"
            # allow ssh access as deploy user
            node.vm.provision "shell", inline: "cp -fr /home/vagrant/.ssh /home/deployuser/; chown -R deployuser:deployuser /home/deployuser/.ssh; chown deployuser:deployuser /home/deployuser/.ssh/authorized_keys"
            # Allow deployuser to have passwordless sudo
            node.vm.synced_folder ".", "/vagrant", create: true, owner: "vagrant", group: "vagrant"
            node.vm.synced_folder ".", "/deployuser", owner: deployuser_uid, group: deployuser_uid, mount_options: ["uid=#{deployuser_uid}", "gid=#{deployuser_uid}"]
            # node.vm.synced_folder "../secrets", "/secrets", create: true, owner: "deployuser", group: "deployuser", mount_options: ["uid=#{deployuser_uid}", "gid=#{deployuser_uid}"]

            # env run always
            node.vm.provision "shell", inline: "echo 'source /vagrant/scripts/env.sh' > /etc/profile.d/sa-environment.sh", :run => 'always'
            ### Install yq to query yaml
            node.vm.provision "shell", inline: "ip a"
            # Check env
            node.vm.provision "shell", inline: "export DEBIAN_FRONTEND=noninteractive"
            node.vm.provision "shell", inline: "sudo rm /etc/localtime && sudo ln -s #{timezone_localpath} /etc/localtime", run: "always"
            node.vm.provision "shell", inline: "export DEBIAN_FRONTEND=noninteractive; sudo apt-get install -y sshpass moreutils python-netaddr software-properties-common"
            ### Install Ansible Block ###
            
            if selected_ansible_version == 'latest'
                node.vm.provision "shell", inline: "echo 'installing latest version of ansible with apt-get'"
                node.vm.provision "shell", inline: "sudo apt-add-repository --yes --update ppa:ansible/ansible-2.9"
                node.vm.provision "shell", inline: "sudo apt-get install -y ansible"
            else
                # Installing a specific version of ansible with pip creates dependency issues pip potentially.
                node.vm.provision "shell", inline: "sudo apt-get install -y python-pip"
                node.vm.provision "shell", inline: "pip install --upgrade pip"    
                # to list available versions - pip install ansible==
                node.vm.provision "shell", inline: "sudo -H pip install ansible==#{ansible_version}"
            end
            # configure a connection timeout to prevent ansible from getting stuck when there is an ssh issue.
            node.vm.provision "shell", inline: "echo 'ConnectTimeout 60' >> /etc/ssh/ssh_config"
            node.vm.provision "shell", inline: <<-EOC
                sudo sed -i 's/.*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
            EOC
            node.vm.provision "shell", inline: "set -x; export openfirehawkserver_name=#{openfirehawkserver_name}; export onsite_private_vpn_ip=#{onsite_private_vpn_ip} ; /deployuser/scripts/init-gateway.sh --#{resourcetier}"
            node.vm.provision "shell", inline: "sudo reboot"
            node.vm.provision :reload

            config.vm.provision "bootstrap", type: "shell", run: "never" do |s| # Configure the AWS CLI credentials.
                s.inline = "sudo -i -u deployuser bash -c \"/vagrant/scripts/firehawk-auth-scripts/init-aws-auth-ssh --resourcetier #{resourcetier} --no-prompts --aws-region #{aws_region} --aws-access-key #{aws_access_key} --aws-secret-key #{aws_secret_key}\""
            end

            config.vm.provision "vpn", type: "shell", run: "never" do |s| # Install the AWS VPN dynamic credentials service
                s.inline = "sudo -i -u deployuser bash -c \"/vagrant/scripts/firehawk-auth-scripts/init-aws-auth-vpn --resourcetier #{resourcetier} --install-service\""
            end

            node.vm.post_up_message = "Warning: This is a dev prototype and is not secure.  Machine is up. IP: #{machine[:box]}"

            node.trigger.before :destroy, :halt, :reload do |trigger|
                trigger.info = "Stopping node..."
                trigger.run = {inline: "echo 'stopping node'"}
            end
        end
    end
    VAGRANT_COMMAND = ARGV[0]
    if VAGRANT_COMMAND == "ssh"
        config.ssh.username = 'deployuser'
        config.ssh.extra_args = ["-t", "cd /deployuser; bash --login"]
    end
    # end
end